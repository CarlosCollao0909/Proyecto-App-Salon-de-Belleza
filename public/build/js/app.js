let paso=1;const pasoInicial=1,pasoFinal=4,cita={usuarioID:"",nombre:"",fecha:"",formaPago:"",servicio:{id:"",nombre:"",precio:""},horario:{id:"",horarioSeleccionado:""},comprobante:null};document.addEventListener("DOMContentLoaded",(()=>{iniciarApp()}));const iniciarApp=()=>{mostrarSeccion(),tabs(),botonesPaginador(),paginaSiguiente(),paginaAnterior(),consultarAPIServicios(),obtenerIDCliente(),obtenerNombreCliente(),seleccionarFecha(),seleccionarHorario(),mostrarOcultarFormaPago(),mostrarResumen()},mostrarSeccion=()=>{const e=document.querySelector(".mostrar");e&&e.classList.remove("mostrar");const o=`#paso-${paso}`;document.querySelector(o).classList.add("mostrar");const a=document.querySelector(".tabs .activo");a&&a.classList.remove("activo");document.querySelector(`[data-paso="${paso}"]`).classList.add("activo")},tabs=()=>{document.querySelectorAll(".tabs button").forEach((e=>{e.addEventListener("click",(e=>{paso=parseInt(e.target.dataset.paso),mostrarSeccion(),botonesPaginador()}))}))},botonesPaginador=()=>{const e=document.querySelector("#siguiente"),o=document.querySelector("#anterior");1===paso?(o.classList.add("ocultarBoton"),e.classList.remove("ocultarBoton")):4===paso?(o.classList.remove("ocultarBoton"),e.classList.add("ocultarBoton"),mostrarResumen()):(o.classList.remove("ocultarBoton"),e.classList.remove("ocultarBoton")),mostrarSeccion()},paginaSiguiente=()=>{const e=document.querySelector("#siguiente");paso>=4||e.addEventListener("click",(()=>{paso++,botonesPaginador()}))},paginaAnterior=()=>{document.querySelector("#anterior").addEventListener("click",(()=>{paso<=1||(paso--,botonesPaginador())}))},consultarAPIServicios=async()=>{try{const e="http://localhost:3000/api/servicios",o=await fetch(e),a=await o.json();mostrarServicios(a)}catch(e){console.log(e)}},mostrarServicios=e=>{e.forEach((e=>{const{id:o,nombre:a,precio:t}=e,n=document.createElement("P");n.classList.add("nombre-servicio"),n.textContent=a;const r=document.createElement("P");r.classList.add("precio-servicio"),r.textContent=`Bs. ${t}`;const c=document.createElement("DIV");c.classList.add("servicio"),c.dataset.idServicio=o,c.onclick=()=>{seleccionarServicio(e)},c.appendChild(n),c.appendChild(r),document.querySelector("#servicios").appendChild(c)}))},seleccionarServicio=e=>{const{id:o,nombre:a,precio:t}=e,n=document.querySelector(`[data-id-servicio="${o}"]`);if(cita.servicio.id===o)cita.servicio.id="",n.classList.remove("seleccionado");else{if(cita.servicio.id){const e=document.querySelector(`[data-id-servicio="${cita.servicio.id}"]`);e&&e.classList.remove("seleccionado")}cita.servicio.id=o,cita.servicio.nombre=a,cita.servicio.precio=t,n.classList.add("seleccionado")}console.log(cita)},consultarAPIHorarios=async()=>{console.log(cita.fecha);try{const e=`http://localhost:3000/api/horarios?fecha=${cita.fecha}`,o=await fetch(e),a=await o.json();mostrarHorarios(a)}catch(e){console.log(e)}},mostrarHorarios=e=>{const o=document.querySelector("#horarios");for(;o.firstChild;)o.removeChild(o.firstChild);const a=document.createElement("OPTION");if(a.textContent="-- Selecciona un horario --",a.disabled=!0,a.selected=!0,o.appendChild(a),0===e.length){const e=document.createElement("OPTION");return e.textContent="No hay horarios disponibles",e.disabled=!0,void o.appendChild(e)}e.forEach((e=>{const{id:a,horaInicio:t,horaFin:n}=e,r=document.createElement("OPTION");r.value=a,r.textContent=`${t} - ${n}`,o.appendChild(r)}))},seleccionarHorario=()=>{document.querySelector("#horarios").addEventListener("change",(e=>{cita.horario.id=parseInt(e.target.selectedOptions[0].value),cita.horario.horarioSeleccionado=e.target.selectedOptions[0].text}))},obtenerIDCliente=()=>{const e=document.querySelector("#id").value;cita.usuarioID=e},obtenerNombreCliente=()=>{const e=document.querySelector("#nombre").value;cita.nombre=e},seleccionarFecha=()=>{document.querySelector("#fecha").addEventListener("input",(e=>{const o=new Date(e.target.value).getUTCDay();[0].includes(o)?(e.target.value="",mostrarAlerta("No hay atención domingo","error",".formulario")):(cita.fecha=e.target.value,consultarAPIHorarios())}));const e=document.querySelector("#horarios");if(!cita.fecha){const o=document.createElement("OPTION");o.textContent="Selecciona una fecha para ver los horarios disponibles",o.disabled=!0,e.appendChild(o)}},mostrarAlerta=(e,o,a,t=!0)=>{const n=document.querySelector(".alerta");n&&n.remove();const r=document.createElement("DIV");r.textContent=e,r.classList.add("alerta"),r.classList.add(o);document.querySelector(a).appendChild(r),t&&setTimeout((()=>{r.remove()}),2500)},mostrarOcultarFormaPago=()=>{const e=document.querySelectorAll('input[name="pago"]'),o=document.querySelector("#informacion__pago"),a=o.dataset.qrUrl;e.forEach((e=>{e.addEventListener("click",(e=>{if(o.innerHTML="","1"===e.target.value){cita.formaPago=e.target.value;const a=document.createElement("P");a.classList.add("text-center"),a.textContent="Presiona el boton siguiente para continuar",o.appendChild(a)}else if("2"===e.target.value){cita.formaPago=e.target.value;const t=document.createElement("P");if(t.classList.add("text-center","parrafo__indicativo"),t.textContent="",Object.values(cita.servicio).includes(""))mostrarAlerta("Por favor selecciona un servicio para visualizar el código QR","error",".informacion__pago",!1),e.target.checked=!1;else{t.textContent="Escanea el codigo QR desde tu aplicacion del banco para pagar el costo del servicio: ";const e=document.createElement("SPAN");e.textContent=`Bs. ${cita.servicio.precio}`,t.appendChild(e),o.appendChild(t);const n=document.createElement("DIV");n.classList.add("campo__file");const r=document.createElement("LABEL");r.setAttribute("for","comprobante"),r.classList.add("label__file"),r.textContent="Subir el comprobante";const c=document.createElement("I");c.classList.add("fa-solid","fa-upload"),r.appendChild(c),n.appendChild(r);const s=document.createElement("INPUT");s.type="file",s.accept="image/jpg, image/jpeg, image/png",s.name="qr",s.id="comprobante",s.classList.add("input__file"),s.addEventListener("change",(e=>{console.log(e.target.files[0]),cita.comprobante=e.target.files[0]})),n.appendChild(s),o.appendChild(n);const i=document.createElement("IMG");i.src=a,o.appendChild(i)}}}))}))},mostrarResumen=()=>{const e=document.querySelector(".contenido-resumen");for(;e.firstChild;)e.removeChild(e.firstChild);if(Object.values(cita).includes("")||Object.values(cita.servicio).includes("")||Object.values(cita.horario).includes(""))return void mostrarAlerta("Faltan datos de los servicios, fecha, horario o forma de pago","error",".contenido-resumen",!1);if("2"===cita.formaPago&&!cita.comprobante)return void mostrarAlerta("Falta el comprobante de pago","error",".contenido-resumen",!1);const{nombre:o,fecha:a,horario:t,servicio:n}=cita,r=new Date(a),c=r.getMonth(),s=r.getDate()+2,i=r.getFullYear(),d=new Date(Date.UTC(i,c,s)).toLocaleDateString("es-BO",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),l=document.createElement("H3");l.textContent="Resumen de los Datos de la Cita",l.classList.add("resumen-heading"),e.appendChild(l);const m=document.createElement("DIV");m.classList.add("resumen-decorador"),e.appendChild(m);const u=document.createElement("DIV");u.classList.add("contenedor-resumen"),e.appendChild(u);const p=document.createElement("DIV");p.classList.add("resumen-seccion");const v=document.createElement("DIV");v.classList.add("resumen-campo"),v.innerHTML=`\n        <div class="resumen-icono resumen-icono-usuario"></div>\n        <div class="resumen-info">\n            <span class="resumen-etiqueta">Nombre:</span>\n            <p class="resumen-valor">${o}</p>\n        </div>\n    `;const h=document.createElement("DIV");h.classList.add("resumen-campo"),h.innerHTML=`\n        <div class="resumen-icono resumen-icono-calendario"></div>\n        <div class="resumen-info">\n            <span class="resumen-etiqueta">Fecha:</span>\n            <p class="resumen-valor">${d}</p>\n        </div>\n    `;const g=document.createElement("DIV");g.classList.add("resumen-campo"),g.innerHTML=`\n        <div class="resumen-icono resumen-icono-reloj"></div>\n        <div class="resumen-info">\n            <span class="resumen-etiqueta">Hora:</span>\n            <p class="resumen-valor">${t.horarioSeleccionado}</p>\n        </div>\n    `,p.appendChild(v),p.appendChild(h),p.appendChild(g),u.appendChild(p);const f=document.createElement("DIV");f.classList.add("resumen-separador"),u.appendChild(f);const C=document.createElement("DIV");C.classList.add("resumen-seccion");const L=document.createElement("DIV");L.classList.add("resumen-campo"),L.innerHTML=`\n        <div class="resumen-icono resumen-icono-tijeras"></div>\n        <div class="resumen-info">\n            <span class="resumen-etiqueta">Servicio:</span>\n            <p class="resumen-valor">${n.nombre}</p>\n        </div>\n    `;const b=document.createElement("DIV");b.classList.add("resumen-campo","resumen-pago"),b.innerHTML=`\n        <div class="resumen-icono resumen-icono-tarjeta"></div>\n        <div class="resumen-info-contenedor">\n            <div class="resumen-info-pago">\n                <span class="resumen-etiqueta">Total:</span>\n                <p class="resumen-valor resumen-valor-precio">Bs. ${n.precio}</p>\n            </div>\n            <div class="resumen-info-pago">\n                <span class="resumen-etiqueta">Forma de Pago:</span>\n                <p class="resumen-valor">${"1"===cita.formaPago?"Efectivo":"QR"}</p>\n            </div>\n        </div>\n    `,C.appendChild(L),C.appendChild(b),u.appendChild(C);const S=document.createElement("DIV");S.classList.add("resumen-acciones");const E=document.createElement("BUTTON");E.classList.add("boton","boton-confirmar"),E.textContent="Confirmar Cita",E.onclick=reservarCita,S.appendChild(E),e.appendChild(S)},reservarCita=async()=>{const{usuarioID:e,fecha:o,horario:a,servicio:t,formaPago:n}=cita,r=new FormData;r.append("usuarioID",e),r.append("fecha",o),r.append("horarioID",a.id),r.append("servicioID",t.id),r.append("formaPagoID",n);try{const e="http://localhost:3000/api/citas",o=await fetch(e,{method:"POST",body:r}),a=await o.json();console.log(a.resultado),a.resultado&&Swal.fire({icon:"success",title:"Cita creada",text:"La cita se ha creado correctamente"}).then((()=>{setTimeout((()=>{window.location.reload()}),1e3)}))}catch(e){Swal.fire({icon:"error",title:"Error...",text:"Hubo un error al guardar la cita"}),console.log(e)}};