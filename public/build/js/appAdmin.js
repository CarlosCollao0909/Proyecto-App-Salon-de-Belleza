document.addEventListener("DOMContentLoaded",(()=>{iniciarApp()}));const iniciarApp=()=>{mostrarAlerta(),mostrarConfirmacionEliminar(),iniciarDatatables("myTable"),cambiarEstadoBotones(),mostrarVistaPreviaQR(),irArriba(),mostrarFullCalendar()},limpiarParametroURL=a=>{const e=new URL(window.location.href);e.searchParams.delete(a),window.history.replaceState({},document.title,e.pathname)},mostrarAlerta=()=>{const a=new URLSearchParams(window.location.search);"1"===a.get("servicio_creado")?Swal.fire({icon:"success",title:"Servicio creado",text:"El nuevo servicio fue registrado correctamente.",confirmButtonText:"OK"}).then((()=>{limpiarParametroURL("servicio_creado")})):"1"===a.get("servicio_actualizado")?Swal.fire({icon:"success",title:"Servicio actualizado",text:"El servicio fue actualizado correctamente.",confirmButtonText:"OK"}).then((()=>{limpiarParametroURL("servicio_actualizado")})):"1"===a.get("servicio_eliminado")?Swal.fire({icon:"success",title:"Servicio eliminado",text:"El servicio fue eliminado correctamente.",confirmButtonText:"OK"}).then((()=>{limpiarParametroURL("servicio_eliminado")})):"1"===a.get("forma_pago_actualizada")?Swal.fire({icon:"success",title:"Forma de pago actualizada",text:"La forma de pago fue actualizada correctamente.",confirmButtonText:"OK"}).then((()=>{limpiarParametroURL("forma_pago_actualizada")})):"1"===a.get("cita_actualizada")&&Swal.fire({icon:"success",title:"Cita actualizada",text:"El estado de la cita fue actualizado correctamente.",confirmButtonText:"OK"}).then((()=>{limpiarParametroURL("cita_actualizada")}))},mostrarConfirmacionEliminar=()=>{const a=document.querySelectorAll(".table__formulario");0!==a.length&&a.forEach((a=>{a.addEventListener("submit",(function(e){e.preventDefault(),Swal.fire({title:"Â¿EstÃ¡s seguro?",text:"Â¡Esta acciÃ³n no se puede deshacer!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"SÃ­, eliminar",cancelButtonText:"Cancelar"}).then((e=>{e.isConfirmed&&a.submit()}))}))}))},iniciarDatatables=a=>{$(document).ready((function(){$(`#${a}`).length&&$(`#${a}`).DataTable({columns:[{type:"string"},{type:"string"},{type:"string"}],responsive:!0,language:{url:"https://cdn.datatables.net/plug-ins/2.3.0/i18n/es-ES.json",lengthLabels:{"-1":"Todos"}},lengthMenu:[5,10,15,25,30,-1]})}))},cambiarEstadoBotones=()=>{const a=document.querySelectorAll(".btn-toggle-estado");0!==a.length&&a.forEach((a=>{a.addEventListener("click",(()=>cambiarEstadoHorarios(a)))}))},cambiarEstadoHorarios=async a=>{const e=a.dataset.id,t="0"===a.dataset.estado?"1":"0";try{const o="/api/horarios/estado",n=new FormData;n.append("id",e),n.append("estado",t);const i=await fetch(o,{method:"POST",body:n}),r=await i.json();if(r.resultado){const e=a.querySelector("i");a.dataset.estado=t,a.textContent="1"===t?"Deshabilitar":"Habilitar",a.classList.toggle("table__accion--deshabilitar","1"===t),a.classList.toggle("table__accion--habilitar","0"===t),a.prepend(e),e.classList.toggle("fa-eye-slash","1"===t),e.classList.toggle("fa-eye","0"===t),Swal.fire({icon:"success",title:"Estado cambiado",text:"El estado del horario fue cambiado correctamente.",confirmButtonText:"OK"})}else Swal.fire({icon:"error",title:"Error al cambiar el estado",text:r.mensaje||"No se pudo cambiar el estado del horario.",confirmButtonText:"OK"})}catch(a){console.log(a),Swal.fire({icon:"error",title:"Error al cambiar el estado",text:"No se pudo cambiar el estado del horario.",confirmButtonText:"OK"})}},mostrarVistaPreviaQR=()=>{const a=document.querySelector("#imagenQR"),e=document.querySelector(".formulario-admin__imagen"),t=document.querySelector("#preview");a&&(a.addEventListener("change",(function(){const a=this.files[0];if(a){const o=new FileReader;o.addEventListener("load",(function(){e.src=this.result,e.style.display="block",t.style.display="none"})),o.readAsDataURL(a)}else e.src="",e.style.display="none",t.style.display="block"})),e.getAttribute("src")&&""!==e.getAttribute("src")||(e.style.display="none"))},irArriba=()=>{const a=document.querySelector(".ir-arriba"),e=document.querySelector(".dashboard__contenido");a.addEventListener("click",(()=>{console.log("Subiendo..."),e.scrollTo({top:0,behavior:"smooth"})})),e.addEventListener("scroll",(()=>{e.scrollTop>100?a.style.display="block":a.style.display="none"}))},mostrarFullCalendar=()=>{const a=document.querySelector("#calendario");if(!a)return;let e=new FullCalendar.Calendar(a,{initialView:"dayGridMonth",height:"auto",showNonCurrentDates:!1,fixedWeekCount:!1,headerToolbar:{left:"dayGridMonth,timeGridWeek",center:"title",right:"prev,next"},buttonText:{month:"Mes",week:"Semana",day:"DÃ­a"},locale:"es",selectable:!0,selectMirror:!0,unselectAuto:!0,dayMaxEvents:1,moreLinkClick:"popover",moreLinkText:a=>`+${a} mÃ¡s`,dateClick:a=>{const e=encodeURIComponent(a.dateStr);consultarAPICitasPorDia(e)},eventDidMount:function(a){const e=new Date(a.event.start),t=new Date;t.setHours(0,0,0,0),a.el.style.backgroundColor="transparent",a.el.style.borderColor="transparent",e<t?(a.el.style.backgroundColor="#f93a3a",a.el.style.color="#FFFFFF"):(a.el.style.backgroundColor="#66cc33",a.el.style.color="#FFFFFF")}});e.render(),agregarLeyenda();const t=(new Date).toLocaleDateString("en-CA");consultarAPICitasPorDia(t),consultarAPICitas(e)},agregarLeyenda=()=>{const a=document.querySelector(".contenedor-calendario");if(!a)return;if(document.querySelector(".calendario-leyenda"))return;const e=document.createElement("div");e.className="calendario-leyenda",e.innerHTML='\n        <div class="calendario-leyenda__item">\n            <div class="color-indicator color-indicator--pasado"></div>\n            <span>Citas Pasadas</span>\n        </div>\n        <div class="calendario-leyenda__item">\n            <div class="color-indicator color-indicator--futuro"></div>\n            <span>Citas Futuras</span>\n        </div>\n    ',a.appendChild(e)},consultarAPICitas=async a=>{try{const e="http://localhost:3000/api/citas_admin",t=await fetch(e),o=await t.json();if(console.log("Citas obtenidas:",o),a){const e=o.map((a=>({title:a.cliente,start:a.fecha,allDay:!0})));a.removeAllEvents(),a.addEventSource(e),console.log("Eventos aÃ±adidos al calendario:",e)}}catch(a){console.error("Error al consultar la API de citas:",a)}},consultarAPICitasPorDia=async a=>{try{const e=`http://localhost:3000/api/citas_admin?fecha=${a}`,t=await fetch(e),o=await t.json();console.log("Citas obtenidas para la fecha:",a,o),mostrarCitas(o)}catch(a){console.error("Error al consultar la API de citas por dÃ­a:",a)}},mostrarCitas=a=>{const e=document.querySelector("#citas");if(e.innerHTML="",!a||0===a.length)return void(e.innerHTML='\n            <div class="no-citas">\n                <div class="no-citas__icon">ðŸ“…</div>\n                <h3 class="no-citas__mensaje">No se encontraron citas para la fecha seleccionada.</h3>\n            </div>');const t=document.createElement("h3");t.className="citas-header",t.textContent="Citas de la fecha seleccionada",e.appendChild(t),a.forEach((a=>{const t=document.createElement("div");t.className="cita-card",t.innerHTML=`\n            <div class="cita-card__header">\n                <div class="cita-card__cliente">${a.cliente}</div>\n                <div class="cita-card__horario">${a.horario}</div>\n            </div>\n            \n            <div class="cita-card__detalles">\n                <div class="cita-card__detalle-item">\n                    <span class="label">Servicio</span>\n                    <span class="valor">${a.servicio}</span>\n                </div>\n                \n                <div class="cita-card__detalle-item">\n                    <span class="label">Precio</span>\n                    <span class="valor valor--precio">Bs. ${a.precio}</span>\n                </div>\n                \n                <div class="cita-card__detalle-item">\n                    <span class="label">Estado</span>\n                    <span class="valor">\n                        <span class="cita-card__estado cita-card__estado--${a.estado}">${a.estado}</span>\n                    </span>\n                </div>\n                \n                <div class="cita-card__detalle-item">\n                    <span class="label">Forma de pago</span>\n                    <span class="valor">${a.formaPago}</span>\n                </div>\n                \n                <div class="cita-card__detalle-item">\n                    <span class="label">Email</span>\n                    <span class="valor">${a.email}</span>\n                </div>\n                \n                <div class="cita-card__detalle-item">\n                    <span class="label">TelÃ©fono</span>\n                    <span class="valor">${a.telefono}</span>\n                </div>\n            </div>\n            \n            ${a.comprobantePago?`\n                <div class="cita-card__comprobante">\n                    <p><strong>Comprobante:</strong></p>\n                    <img src="/images/comprobantes/${a.comprobantePago}" alt="Comprobante de pago">\n                </div>\n            `:""}\n\n            ${"confirmada"===a.estado?`\n                <div class="cita-card__accion">\n                    <form action="/admin/citas/editar" method="POST">\n                        <input type="hidden" name="id" value="${a.id}">\n                        <button type="submit" class="cita-card__boton">Marcar como Finalizada</button>\n                    </form>\n                </div>\n            `:""}\n        `,e.appendChild(t)}))};