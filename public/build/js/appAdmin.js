document.addEventListener("DOMContentLoaded",(()=>{iniciarApp()}));const iniciarApp=()=>{mostrarAlerta(),mostrarConfirmacionEliminar(),iniciarDatatables("myTable"),cambiarEstadoBotones(),mostrarVistaPreviaQR(),irArriba(),mostrarFullCalendar(),cargarGraficoMensual(),cargarGraficoDiario(),cargarGraficoServicios(),cargarGraficoClientes(),cargarGraficoHorarios(),validarCamposServicio()},limpiarParametroURL=a=>{const e=new URL(window.location.href);e.searchParams.delete(a),window.history.replaceState({},document.title,e.pathname)},mostrarAlerta=()=>{const a=new URLSearchParams(window.location.search);"1"===a.get("servicio_creado")?Swal.fire({icon:"success",title:"Servicio creado",text:"El nuevo servicio fue registrado correctamente.",confirmButtonText:"OK"}).then((()=>{limpiarParametroURL("servicio_creado")})):"1"===a.get("servicio_actualizado")?Swal.fire({icon:"success",title:"Servicio actualizado",text:"El servicio fue actualizado correctamente.",confirmButtonText:"OK"}).then((()=>{limpiarParametroURL("servicio_actualizado")})):"1"===a.get("servicio_eliminado")?Swal.fire({icon:"success",title:"Servicio eliminado",text:"El servicio fue eliminado correctamente.",confirmButtonText:"OK"}).then((()=>{limpiarParametroURL("servicio_eliminado")})):"1"===a.get("forma_pago_actualizada")?Swal.fire({icon:"success",title:"Forma de pago actualizada",text:"La forma de pago fue actualizada correctamente.",confirmButtonText:"OK"}).then((()=>{limpiarParametroURL("forma_pago_actualizada")})):"1"===a.get("cita_actualizada")&&Swal.fire({icon:"success",title:"Cita actualizada",text:"El estado de la cita fue actualizado correctamente.",confirmButtonText:"OK"}).then((()=>{limpiarParametroURL("cita_actualizada")}))},mostrarConfirmacionEliminar=()=>{const a=document.querySelectorAll(".table__formulario");0!==a.length&&a.forEach((a=>{a.addEventListener("submit",(function(e){e.preventDefault(),Swal.fire({title:"¿Estás seguro?",text:"¡Esta acción no se puede deshacer!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"}).then((e=>{e.isConfirmed&&a.submit()}))}))}))},iniciarDatatables=a=>{$(document).ready((function(){$(`#${a}`).length&&$(`#${a}`).DataTable({columns:[{type:"string"},{type:"string"},{type:"string"}],responsive:!0,language:{url:"https://cdn.datatables.net/plug-ins/2.3.0/i18n/es-ES.json",lengthLabels:{"-1":"Todos"}},lengthMenu:[5,10,15,25,30,-1]})}))},cambiarEstadoBotones=()=>{const a=document.querySelectorAll(".btn-toggle-estado");0!==a.length&&a.forEach((a=>{a.addEventListener("click",(()=>cambiarEstadoHorarios(a)))}))},cambiarEstadoHorarios=async a=>{const e=a.dataset.id,t="0"===a.dataset.estado?"1":"0";try{const o="/api/horarios/estado",r=new FormData;r.append("id",e),r.append("estado",t);const i=await fetch(o,{method:"POST",body:r}),n=await i.json();if(n.resultado){const e=a.querySelector("i");a.dataset.estado=t,a.textContent="1"===t?"Deshabilitar":"Habilitar",a.classList.toggle("table__accion--deshabilitar","1"===t),a.classList.toggle("table__accion--habilitar","0"===t),a.prepend(e),e.classList.toggle("fa-eye-slash","1"===t),e.classList.toggle("fa-eye","0"===t),Swal.fire({icon:"success",title:"Estado cambiado",text:"El estado del horario fue cambiado correctamente.",confirmButtonText:"OK"})}else Swal.fire({icon:"error",title:"Error al cambiar el estado",text:n.mensaje||"No se pudo cambiar el estado del horario.",confirmButtonText:"OK"})}catch(a){console.log(a),Swal.fire({icon:"error",title:"Error al cambiar el estado",text:"No se pudo cambiar el estado del horario.",confirmButtonText:"OK"})}},mostrarVistaPreviaQR=()=>{const a=document.querySelector("#imagenQR"),e=document.querySelector(".formulario-admin__imagen"),t=document.querySelector("#preview");a&&(a.addEventListener("change",(function(){const a=this.files[0];if(a){const o=new FileReader;o.addEventListener("load",(function(){e.src=this.result,e.style.display="block",t.style.display="none"})),o.readAsDataURL(a)}else e.src="",e.style.display="none",t.style.display="block"})),e.getAttribute("src")&&""!==e.getAttribute("src")||(e.style.display="none"))},irArriba=()=>{const a=document.querySelector(".ir-arriba"),e=document.querySelector(".dashboard__contenido");a.addEventListener("click",(()=>{console.log("Subiendo..."),e.scrollTo({top:0,behavior:"smooth"})})),e.addEventListener("scroll",(()=>{e.scrollTop>100?a.style.display="block":a.style.display="none"}))},mostrarFullCalendar=()=>{const a=document.querySelector("#calendario");if(!a)return;let e=new FullCalendar.Calendar(a,{initialView:"dayGridMonth",height:"auto",showNonCurrentDates:!1,fixedWeekCount:!1,headerToolbar:{left:"dayGridMonth,timeGridWeek",center:"title",right:"prev,next"},buttonText:{month:"Mes",week:"Semana",day:"Día"},locale:"es",selectable:!0,selectMirror:!0,unselectAuto:!0,dayMaxEvents:1,moreLinkClick:"popover",moreLinkText:a=>`+${a} más`,dateClick:a=>{const e=encodeURIComponent(a.dateStr);consultarAPICitasPorDia(e)},eventDidMount:function(a){const e=new Date(a.event.start),t=new Date;t.setHours(0,0,0,0),a.el.style.backgroundColor="transparent",a.el.style.borderColor="transparent",e<t?(a.el.style.backgroundColor="#f93a3a",a.el.style.color="#FFFFFF"):(a.el.style.backgroundColor="#66cc33",a.el.style.color="#FFFFFF")}});e.render(),agregarLeyenda();const t=(new Date).toLocaleDateString("en-CA");consultarAPICitasPorDia(t),consultarAPICitas(e)},agregarLeyenda=()=>{const a=document.querySelector(".contenedor-calendario");if(!a)return;if(document.querySelector(".calendario-leyenda"))return;const e=document.createElement("div");e.className="calendario-leyenda",e.innerHTML='\n        <div class="calendario-leyenda__item">\n            <div class="color-indicator color-indicator--pasado"></div>\n            <span>Citas Pasadas</span>\n        </div>\n        <div class="calendario-leyenda__item">\n            <div class="color-indicator color-indicator--futuro"></div>\n            <span>Citas Futuras</span>\n        </div>\n    ',a.appendChild(e)},consultarAPICitas=async a=>{try{const e="http://localhost:3000/api/citas_admin",t=await fetch(e),o=await t.json();if(console.log("Citas obtenidas:",o),a){const e=o.map((a=>({title:a.cliente,start:a.fecha,allDay:!0})));a.removeAllEvents(),a.addEventSource(e),console.log("Eventos añadidos al calendario:",e)}}catch(a){console.error("Error al consultar la API de citas:",a)}},consultarAPICitasPorDia=async a=>{try{const e=`http://localhost:3000/api/citas_admin?fecha=${a}`,t=await fetch(e),o=await t.json();console.log("Citas obtenidas para la fecha:",a,o),mostrarCitas(o,a)}catch(a){console.error("Error al consultar la API de citas por día:",a)}},mostrarCitas=(a,e)=>{const t=document.querySelector("#citas");if(t.innerHTML="",!a||0===a.length)return void(t.innerHTML='\n            <div class="no-citas">\n                <div class="no-citas__icon">📅</div>\n                <h3 class="no-citas__mensaje">No se encontraron citas para la fecha seleccionada.</h3>\n            </div>');const o=document.createElement("h3");o.className="citas-header",o.textContent=`Citas para la fecha: ${e}`,t.appendChild(o),a.forEach((a=>{const e=document.createElement("div");e.className="cita-card",e.innerHTML=`\n            <div class="cita-card__header">\n                <div class="cita-card__cliente">${a.cliente}</div>\n                <div class="cita-card__horario">${a.horario}</div>\n            </div>\n            \n            <div class="cita-card__detalles">\n                <div class="cita-card__detalle-item">\n                    <span class="label">Servicio</span>\n                    <span class="valor valor--capitalize">${a.servicio.toLowerCase()}</span>\n                </div>\n                \n                <div class="cita-card__detalle-item">\n                    <span class="label">Precio</span>\n                    <span class="valor valor--precio">Bs. ${a.precio}</span>\n                </div>\n                \n                <div class="cita-card__detalle-item">\n                    <span class="label">Estado</span>\n                    <span class="valor">\n                        <span class="cita-card__estado cita-card__estado--${a.estado}">${a.estado}</span>\n                    </span>\n                </div>\n                \n                <div class="cita-card__detalle-item">\n                    <span class="label">Forma de pago</span>\n                    <span class="valor valor--capitalize">${a.formaPago.toLowerCase()}</span>\n                </div>\n                \n                <div class="cita-card__detalle-item">\n                    <span class="label">Email</span>\n                    <span class="valor">${a.email}</span>\n                </div>\n                \n                <div class="cita-card__detalle-item">\n                    <span class="label">Teléfono</span>\n                    <span class="valor">${a.telefono}</span>\n                </div>\n            </div>\n            \n            ${a.comprobantePago?`\n                <div class="cita-card__comprobante">\n                    <p><strong>Comprobante:</strong></p>\n                    <img src="/images/comprobantes/${a.comprobantePago}" alt="Comprobante de pago">\n                </div>\n            `:""}\n\n            ${"confirmada"===a.estado?`\n                <div class="cita-card__accion">\n                    <form action="/admin/citas/editar" method="POST">\n                        <input type="hidden" name="id" value="${a.id}">\n                        <button type="submit" class="cita-card__boton">Marcar como Finalizada</button>\n                    </form>\n                </div>\n            `:""}\n        `,t.appendChild(e)}))},cargarGraficoMensual=async()=>{const a=await fetch("/api/reportes/ingresos_mensuales"),e=await a.json(),t=e.map((a=>a.mes)),o=e.map((a=>a.total_ingresos));document.getElementById("graficoMensual")&&new Chart(document.getElementById("graficoMensual"),{type:"bar",data:{labels:t,datasets:[{label:"Ingresos por mes",data:o,backgroundColor:"rgba(66, 133, 244, 0.7)",borderColor:"rgba(66, 133, 244, 1)",borderWidth:1}]},options:{plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})},cargarGraficoDiario=async()=>{const a=await fetch("/api/reportes/ingresos_diarios"),e=await a.json(),t=e.map((a=>a.fecha)),o=e.map((a=>a.total_ingresos));document.getElementById("graficoDiario")&&new Chart(document.getElementById("graficoDiario"),{type:"line",data:{labels:t,datasets:[{label:"Ingresos por día",data:o,fill:{target:"origin",above:"rgba(52, 168, 83, 0.1)"},borderColor:"rgba(52, 168, 83, 0.8)",tension:.3,pointRadius:5,pointBackgroundColor:"rgba(52, 168, 83, 1)"}]},options:{plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})},cargarGraficoServicios=async()=>{const a=await fetch("/api/reportes/servicios_solicitados"),e=await a.json(),t=e.map((a=>a.servicio)),o=e.map((a=>a.cantidad));document.getElementById("graficoServicios")&&new Chart(document.getElementById("graficoServicios"),{type:"pie",data:{labels:t,datasets:[{label:"Cantidad de veces Solicitado",data:o,backgroundColor:["rgba(66, 133, 244, 0.8)","rgba(219, 68, 55, 0.8)","rgba(244, 180, 0, 0.8)","rgba(52, 168, 83, 0.8)","rgba(156, 39, 176, 0.8)","rgba(3, 169, 244, 0.8)","rgba(255, 152, 0, 0.8)","rgba(0, 150, 136, 0.8)"],borderColor:"white",borderWidth:2}]}})},cargarGraficoClientes=async()=>{const a=await fetch("/api/reportes/clientes_frecuentes"),e=await a.json(),t=e.map((a=>a.cliente)),o=e.map((a=>a.cantidad_citas));document.getElementById("graficoClientes")&&new Chart(document.getElementById("graficoClientes"),{type:"bar",data:{labels:t,datasets:[{label:"Citas Agendadas por Cliente",data:o,backgroundColor:"rgba(219, 68, 55, 0.7)",borderColor:"rgba(219, 68, 55, 1)",borderWidth:1}]},options:{plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})},cargarGraficoHorarios=async()=>{const a=await fetch("/api/reportes/horarios_demandados"),e=await a.json(),t=e.map((a=>a.horario)),o=e.map((a=>a.cantidad));document.getElementById("graficoHorarios")&&new Chart(document.getElementById("graficoHorarios"),{type:"bar",data:{labels:t,datasets:[{label:"Cantidad de citas por horario",data:o,backgroundColor:"rgba(244, 180, 0, 0.7)",borderColor:"rgba(244, 180, 0, 1)",borderWidth:1}]},options:{plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})},validarCamposServicio=()=>{const a=document.getElementById("nombre"),e=document.getElementById("precio");a.addEventListener("input",(function(){this.value=this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g,"").toUpperCase()})),e.addEventListener("input",(function(){this.value=this.value.replace(/[^0-9.]/g,"");const a=this.value.split(".");a.length>2&&(this.value=a[0]+"."+a[1]),a[1]&&a[1].length>2&&(this.value=a[0]+"."+a[1].substring(0,2)),parseFloat(this.value)>999.99&&(this.value="")}))};